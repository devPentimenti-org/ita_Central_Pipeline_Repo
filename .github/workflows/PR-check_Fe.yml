name: PR check and Code Quality analysis (JS/TS)

on:
  workflow_call:
    inputs:
      run-tests:
        description: 'Run unit tests + coverage'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read
  checks: write

jobs:
  quality-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate PR
        uses: neofinancial/ticket-check-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ticketLink: 'https://pentimenti1.atlassian.net/browse/PD-%ticketNumber%'
          ticketPrefix: 'PD-'
          titleRegex: '^PD-(?<ticketNumber>\d+)'
          titleFormat: '%prefix%%id%: %title%'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci
        
      - name: Check formatting (Prettier)
        run: npx prettier --check . || true

      - name: Run ESLint (JSON output)
        run: |
          npx eslint . \
            --ext .js,.jsx,.ts,.tsx \
            --format json \
            --output-file lint.json || true

      - name: Analyze ESLint results
        run: |
          if [ -s lint.json ]; then
            UNUSED=$(jq '
            [
             .[].messages[]
             | select(
                (.ruleId == "no-unused-vars") or
                (.ruleId == "@typescript-eslint/no-unused-vars") or
                (.ruleId != null and (.ruleId | startswith("unused-imports")))
              )
            ] | length
            ' lint.json)

            TOTAL=$(jq '
            [.[].messages[] | select(.ruleId != null)] | length
            ' lint.json)

            SMELLS=$(( TOTAL - UNUSED ))
          else
           UNUSED=0
           SMELLS=0
          fi

          echo "UNUSED_VARS=$UNUSED" >> $GITHUB_ENV
          echo "LINT_SMELLS=$SMELLS" >> $GITHUB_ENV

          
      - name: Install Semgrep
        run: |
          pip install --user semgrep
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Run Semgrep Security Scan
        run: semgrep scan --config=auto --json > semgrep.json || true

      - name: Count Security Issues
        run: |
          if [ -s semgrep.json ]; then
            SECURITY_ISSUES=$(jq '.results | length' semgrep.json)
          else
            SECURITY_ISSUES=0
          fi
          echo "SECURITY_ISSUES=$SECURITY_ISSUES" >> $GITHUB_ENV

      - name: Run Tests with Coverage
        if: ${{ inputs.run-tests }}
        run: npm test -- --coverage

      - name: Extract Coverage Percentage
        if: ${{ inputs.run-tests }}
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(jq '.total.lines.pct // 0' coverage/coverage-summary.json | cut -d. -f1)
          else
            COVERAGE=0
          fi
          echo "COVERAGE_PERCENT=$COVERAGE" >> $GITHUB_ENV

      - name: Upload Coverage Artifact
        if: ${{ inputs.run-tests }}
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

      - name: Generate Summary Report
        id: summary
        run: |
          REPORT="## Code Quality & Test Summary

          | Metric                     | Value |
          |----------------------------|-------|
          | Code Smells (Lint)         | ${{ env.LINT_SMELLS }} |
          | Unused Variables           | ${{ env.UNUSED_VARS }} |
          | Security Issues (Semgrep)  | ${{ env.SECURITY_ISSUES }} |
          | Test Coverage              | ${{ env.COVERAGE_PERCENT }}% |

          > Generated on $(date '+%Y-%m-%d %H:%M UTC')"
          echo "$REPORT" >> $GITHUB_STEP_SUMMARY
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR - Summary
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: js-quality-summary
          message: ${{ steps.summary.outputs.summary }}

      - name: Generate Lint Code Smells Report
        id: lint_smells
        run: |
          if [ "${{ env.LINT_SMELLS }}" -eq 0 ]; then
            TABLE="| No | No code smells found | | |"
          else
            TABLE=$(jq -r '
            [
            .[] | .filePath as $file |
            .messages[] |
            select(.ruleId != "no-unused-vars") |
            {
              file: ($file | split("/") | last),
              path: $file,
              line: .line,
              message: .message
            }
          ]
          | to_entries
          | .[]
          | "| \(.key + 1) | \(.value.path) | \(.value.line) | \(.value.message) |"
          ' lint.json)
          fi

          REPORT="## Code Smells (Lint)

          | Sno | File Path | Line | Message |
          |-----|----------|------|---------|
          $TABLE"

          echo "$REPORT" >> $GITHUB_STEP_SUMMARY
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      - name: Generate Unused Imports / Variables Report
        id: unused
        run: |
          if [ "${{ env.UNUSED_VARS }}" -eq 0 ]; then
            TABLE="| No unused imports or variables found | | |"
          else
            TABLE=$(jq -r '
            [
              .[] | .filePath as $file |
              .messages[] |
              select(
                (.ruleId == "no-unused-vars") or
                (.ruleId == "@typescript-eslint/no-unused-vars") or
                (.ruleId != null and (.ruleId | startswith("unused-imports")))
              ) |
              {
                path: $file,
                line: .line,
                message: .message
              }
            ]
            | to_entries
            | .[]
            | "| \(.key + 1) | \(.value.path) | \(.value.line) | \(.value.message) |"
            ' lint.json)
          fi

          REPORT="## Unused Imports / Variables

          | Sno | File Path | Line | Message |
          |-----|----------|------|---------|
          $TABLE"

          echo "$REPORT" >> $GITHUB_STEP_SUMMARY
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      - name: Generate Security Report
        id: semgrep
        run: |
          if [ "${{ env.SECURITY_ISSUES }}" -eq 0 ]; then
            TABLE="| No security issues found | | | |"
          else
            TABLE=$(jq -r '
              .results[] | "| \(.check_id) | \(.path) | \(.start.line) | \(.extra.message) |"
            ' semgrep.json)
          fi
          REPORT="## Security Vulnerabilities (Semgrep)
          | Rule | File | Line | Message |
          |------|------|------|---------|
          $TABLE"
          echo "$REPORT" >> $GITHUB_STEP_SUMMARY
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR - Security Report
        if: github.event_name == 'pull_request' && env.SECURITY_ISSUES != '0'
        uses: thollander/actions-comment-pull-request@v2
        with:
          comment_tag: js-security-report
          message: ${{ steps.semgrep.outputs.report }}
